@{
    ViewData["Title"] = "點數紀錄";
}


@section Styles
    {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        body {
            caret-color: transparent;
        }

        th, td {
            font-size: 1.3rem;
        }
    </style>
}

<div id="app" style="margin-top: 50px">
    <div class="container">
        <div class="row">
            <div class="col-md-7">
                <div class="dropdown">
                    <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-expanded="true" style="border-radius: 10px">
                        交易來源
                        <span class="caret"></span>
                    </button>

                    <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#" v-on:click="updateSelected('All')">All</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#" v-on:click="updateSelected('Focus')">Focus</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#" v-on:click="updateSelected('Tarot')">Tarot</a></li>
                        <li role="presentation"><a role="menuitem" tabindex="-1" href="#" v-on:click="updateSelected('Product')">Product</a></li>
                    </ul>
                </div>
            </div>
            <div class="col-md-5">
                <span>交易起始日</span>&nbsp
                <input type="date" name="start" v-model="startDate" style="border-radius: 10px; padding: 5px" /> ~
                <span>交易終止日</span>&nbsp
                <input type="date" name="end" v-model="endDate" style="border-radius: 10px; padding: 5px" />
            </div>

            <table class="table table-hover table-border" style="margin-top: 50px">
                <thead>
                    <tr>
                        <th>交易來源</th>
                        <th>交易內容</th>
                        <th>異動數量 <i :class="{'bi':true, 'bi-sort-up': sortTypeA==='asc', 'bi-sort-down':sortTypeA !== 'asc'}" @@click="sortHandler('modifiedAmount')"></i></th>
                        <th>交易時間 <i :class="{'bi':true, 'bi-sort-up': sortTypeT==='asc', 'bi-sort-down':sortTypeT !== 'asc'}" @@click="sortHandler('modifiedTime')"></i></th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="{modifiedSource, content, modifiedAmount, modifiedTime} in pointRecords">
                        <td>{{modifiedSource}}</td>
                        <td>{{content}}</td>
                        <td>{{modifiedAmount}}</td>
                        <td>{{modifiedTime}}</td>
                    </tr>
                </tbody>
            </table>

            {{pointRecords}}
        </div>
    </div>


    @section Scripts{
        <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
        <script>
            const { createApp, ref, watch } = Vue
            createApp({
                setup() {
                    const pointRecords = ref([]) // 顯示在產品中的資料
                    const selectedOption = ref("") // 下拉選單所選的內容
                    const startDate = ref("") // 交易起始日的值
                    const endDate = ref("") // 交易終止日的值
                    const sortBy = ref("")       //排序的欄位
                    const sortTypeA = ref("asc")  //升冪還是降冪
                    const sortTypeT = ref("asc")  //升冪還是降冪
                    //const totalPages = ref(0)   //總共有幾頁
                    //const thePage = ref(1)       //目前是第幾頁

                    const loadPointRecords = async () => {
                        let API_URL = ''
                        if (sortBy == "modifiedAmount") {
                            API_URL = `https://localhost:5000/api/PointHistories?keyword=${selectedOption.value}&startDate=${startDate.value}&endDate=${endDate.value}&sortBy=${sortBy.value}&sortType=${sortTypeA.value}`
                        }
                        else {
                            API_URL = `https://localhost:5000/api/PointHistories?keyword=${selectedOption.value}&startDate=${startDate.value}&endDate=${endDate.value}&sortBy=${sortBy.value}&sortType=${sortTypeT.value}`

                        }
                        const response = await fetch(API_URL, {
                            method: "POST",
                        })
                        const datas = await response.json()
                        pointRecords.value = datas
                        //totalPages.value = datas.totalPages
                    }
                    loadPointRecords()


                    // 下拉選單功能---------------------------------------------------------------------------------------------
                    // 按下選項就觸發方法
                    const updateSelected = (option) => {
                        selectedOption.value = option
                        console.log(option)
                    }

                    // 監看交易來源有沒有改變
                    watch(selectedOption, () => {
                        loadPointRecords()
                    })

                    // 日期區段功能---------------------------------------------------------------------------------------------
                    // 監看起始日有沒有改變
                    watch(startDate, (newValue) => {
                        console.log(newValue)
                        loadPointRecords()
                    })
                    // 監看終止日有沒有改變
                    watch(endDate, (newValue) => {
                        console.log(newValue)
                        loadPointRecords()
                    })

                    // 排序功能---------------------------------------------------------------------------------------------
                    // 按下異動數量欄位的排序icon就觸發方法
                    const sortHandler = type => {
                        sortBy.value = type
                        if (type == "modifiedAmount") {
                            sortTypeA.value = sortTypeA.value === "asc" ? "desc" : "asc" //升冪還是降冪的切換
                        }
                        else {
                            sortTypeT.value = sortTypeT.value === "asc" ? "desc" : "asc" //升冪還是降冪的切換
                        }

                        console.log(sortBy.value, sortTypeA.value, sortTypeT.value)
                        //thePage.value = 1
                        loadPointRecords()

                    }


                    return {
                        pointRecords,
                        updateSelected,
                        startDate,
                        endDate,
                        sortHandler,
                        sortTypeA,
                        sortTypeT,
                        sortBy,
                        //totalPages,
                        //pagingHandler,
                        //thePage
                    }
                }
            }).mount('#app')
        </script>
    }
